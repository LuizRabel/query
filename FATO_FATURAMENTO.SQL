WITH FATURAMENTO_MAQUINAS AS(
SELECT
	BM_DESC AS GRUPO,
	D2_FILIAL AS FK_FILIAL,
	F4_TEXTO AS TRANSACAO,
	CONVERT(DATE,D2_EMISSAO,103) AS DATAEMISSAO,
	D2_DOC AS NOTA,
	D2_SERIE AS SERIE,
	ISNULL(VV9_NUMATE,
	'') AS CODINTERNO,
	CASE
		WHEN VV1_LOCPAD = 'VU' THEN 'USADO'
		ELSE 'NOVO'
	END AS STATUS_VEICULO,
	D2_COD AS CODIGO,
	VV1_CHAINT AS CHAINT,
	VVA_CHASSI AS CHASSI,
	D2_CLIENTE AS FK_CLIENTE,
	D2_LOJA AS LOJCLI,
	LEFT(A1_IBGE,7) AS FK_IBGE,
	A1_CODSIAF SIAF,
	F2_VEND1 AS FK_CODVEN,
	VV2_TIPVEI AS GRUSER,
	VVA_MODVEI AS MODELO,
	VVA_GRUMOD AS GRUMOD,
	LEFT(VV1_FABMOD,
	4) AS FABANO,
	D2_TOTAL AS VLRTOT,
	VV0_PERDES AS PERCENTUAL_DESCONTO,
	VV0_VALDES AS DESCONTO,
	D2_VALICM AS ICMS,
	D2_ICMSRET AS ICMSST,
	D2_VALIMP6 AS PIS,
	D2_VALIMP5 AS COFINS,
	D2_CUSTO1 AS CUSTO,
	D2_VALFRE AS FRETE,
	D2_DESPESA AS DESPESA,
	ROUND((D2_TOTAL-D2_CUSTO1) / CASE WHEN D2_CUSTO1 = 0 THEN D2_TOTAL ELSE D2_CUSTO1 END, 2) * 100 AS MARGEM
FROM
	SD2010 (NOLOCK) SD2 /*ITENS DE VENDA DA NF*/
LEFT JOIN SF2010 (NOLOCK) SF2 ON /*CABEÇALHO DA NF DE SAÍDA*/
	SF2.D_E_L_E_T_ = ' '
	AND F2_FILIAL = D2_FILIAL
	AND F2_DOC = D2_DOC
	AND F2_SERIE = D2_SERIE
LEFT JOIN SA1010 (NOLOCK) SA1 ON /*CADASTRO DE CLIENTES*/
	SA1.D_E_L_E_T_ = ' '
	AND A1_FILIAL = ' '
	AND A1_COD = D2_CLIENTE
	AND A1_LOJA = D2_LOJA
LEFT JOIN SA3010 (NOLOCK) SA3 ON /* CADASTRO DE VENDEDORES */
	SA3.D_E_L_E_T_ = ' '
	AND A3_FILIAL = SUBSTRING(D2_FILIAL, 1, 4)
	AND A3_COD = F2_VEND1
LEFT JOIN SF4010 (NOLOCK) SF4 ON /*TIPOS DE ENTRADA E SAÍDA*/
	SF4.D_E_L_E_T_ = ' '
	AND F4_FILIAL = ' '
	AND F4_CODIGO = D2_TES
LEFT JOIN VV0010 (NOLOCK) VV0 ON /*SAÍDA DE VEÍCULOS*/
	VV0.D_E_L_E_T_ = ' '
	AND VV0_FILIAL = D2_FILIAL
	AND VV0_NUMNFI = D2_DOC
	AND VV0_SERNFI = D2_SERIE
LEFT JOIN VV9010 (NOLOCK) VV9 ON /*RECEPÇÃO DE CLIENTES/VISITANTES */
	VV9.D_E_L_E_T_ = ' '
	AND VV0_FILIAL = VV9_FILIAL
	AND VV9_NUMATE = VV0_NUMTRA
LEFT JOIN VVA010 (NOLOCK) VVA ON /*ITENS DAS SAÍDAS DE VEÍCULOS*/
	VVA.D_E_L_E_T_ = ' '
	AND VVA_FILIAL = VV0_FILIAL
	AND VVA_NUMTRA = VV0_NUMTRA
	--AND VVA_CHAINT = SUBSTRING(D2_COD, 6, 6)
LEFT JOIN VV1010 (NOLOCK) VV1 ON /*CADASTRO DE VEÍCULOS*/
	VV1.D_E_L_E_T_ = ' '
	AND VVA_CHAINT = VV1_CHAINT
	AND VV1_FILIAL = SUBSTRING(VVA_FILIAL, 1, 4)
LEFT JOIN VV2010 (NOLOCK) VV2 ON /*MODELO DE VEÍCULOS*/
	VV2.D_E_L_E_T_ = ' '
	AND VV2_FILIAL = VV1_FILIAL
	AND VV2_CODMAR = VV1_CODMAR
	AND VV2_MODVEI = VV1_MODVEI
	AND VV2_GRUMOD = VVA_GRUMOD
LEFT JOIN SBM010 (NOLOCK) SBM ON /*GRUPO DE PRODUTOS*/
	SBM.D_E_L_E_T_ = ' '
	AND BM_FILIAL = SUBSTRING(D2_FILIAL, 1, 4)
	AND BM_GRUPO = D2_GRUPO
LEFT JOIN SB1010 (NOLOCK) SB1 ON /*DESCRIÇÃO GENÉRICA DE PRODUTOS*/
	SB1.D_E_L_E_T_ = ' '
	AND B1_FILIAL = SUBSTRING(D2_FILIAL, 1, 4)
	AND B1_COD = D2_COD
WHERE
	SD2.D_E_L_E_T_ = ' '
	AND SF2.F2_PREFORI = 'VEI' /*SOMENTE VEÍCULOS*/
	AND F4_OPEMOV = '05' /* OPERAÇÕES DE VENDAS*/
	AND B1_COD NOT IN ('SERV_1001', 'SERV_1002', 'SERV_1009', 'SERV_DES', 'SERV_INC', 'SERV_0802')/* DESCONSIDERA TREINAMENTOS, COMISSOES SOBRE SEGUROS,COMISSOES SOBRE CONSORCIOS,COMISSOES SOBRE VENDAS,COMISSOES SOBRE DESEMPENHO JOHN DEERE ,INCENTIVOS JOHN DEERE                   */
)
SELECT *
FROM FATURAMENTO_MAQUINAS
